class MultiStepForm {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 3;
        this.init();
    }

    init() {
        this.bindEvents();
        this.updateProgress();
        this.togglePerusahaanFields();
    }

    bindEvents() {
        // Next step buttons
        document.querySelectorAll('.next-step').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const nextStep = parseInt(e.target.dataset.next);
                if (this.validateCurrentStep()) {
                    this.goToStep(nextStep);
                }
            });
        });

        // Previous step buttons
        document.querySelectorAll('.prev-step').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const prevStep = parseInt(e.target.dataset.prev);
                this.goToStep(prevStep);
            });
        });

        // Jenis penyewa radio buttons
        document.querySelectorAll('input[name="jenis_penyewa"]').forEach(radio => {
            radio.addEventListener('change', () => {
                this.togglePerusahaanFields();
            });
        });

        // Submit button
        const submitBtn = document.getElementById('submitFormBtn');
        if (submitBtn) {
            submitBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.submitForm();
            });
        }

        // Reset button
        const resetBtn = document.getElementById('resetStep1');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => this.resetStep1());
        }
    }

    validateCurrentStep() {
        switch (this.currentStep) {
            case 1:
                return this.validateStep(1);
            case 2:
                return this.validateStep(2);
            case 3:
                return this.validateStep(3);
            default:
                return true;
        }
    }

    validateStep(step) {
        const stepElement = document.getElementById(`step-${step}`);
        if (!stepElement) return true;

        let isValid = true;
        const requiredFields = stepElement.querySelectorAll('[required]');

        // Hapus error sebelumnya
        requiredFields.forEach(field => this.clearError(field));

        // Validasi setiap field required
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                const fieldName = this.getFieldName(field);
                this.showError(field, `${fieldName} wajib diisi`);
            }
        });

        // Validasi tambahan untuk step 1
        if (step === 1) {
            // Validasi email
            const emailField = stepElement.querySelector('input[type="email"]');
            if (emailField && emailField.value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(emailField.value)) {
                    isValid = false;
                    this.showError(emailField, 'Format email tidak valid');
                }
            }

            // Validasi jenis penyewa (radio button)
            const jenisPenyewa = document.querySelector('input[name="jenis_penyewa"]:checked');
            if (!jenisPenyewa) {
                isValid = false;
                const radioGroup = document.querySelector('input[name="jenis_penyewa"]');
                if (radioGroup) {
                    this.showError(radioGroup.closest('.form-group'), 'Jenis Penyewa wajib dipilih');
                }
            }

            // Validasi kategori
            const kategori = document.getElementById('kategori');
            if (kategori && !kategori.value) {
                isValid = false;
                this.showError(kategori, 'Kategori wajib dipilih');
            }
        }

        // Validasi tambahan untuk step 2 (tanggal)
        if (step === 2) {
            const masaAwal = document.getElementById('masa_awal_perjanjian')?.value;
            const masaAkhir = document.getElementById('masa_akhir_perjanjian')?.value;

            if (masaAwal && masaAkhir) {
                const startDate = new Date(masaAwal);
                const endDate = new Date(masaAkhir);

                if (endDate < startDate) {
                    isValid = false;
                    const akhirField = document.getElementById('masa_akhir_perjanjian');
                    this.showError(akhirField, 'Masa akhir harus setelah masa awal');
                }
            }
        }

        // Validasi tambahan untuk step 3 (harga)
        if (step === 3) {
            const hargaSewa = document.getElementById('harga_sewa')?.value;
            if (!hargaSewa || parseFloat(hargaSewa) <= 0) {
                isValid = false;
                const field = document.getElementById('harga_sewa');
                this.showError(field, 'Harga sewa wajib diisi dan harus lebih dari 0');
            }
        }

        if (!isValid) {
            // Tampilkan alert sederhana
            Swal.fire({
                icon: 'warning',
                title: 'Data Belum Lengkap',
                text: 'Silakan lengkapi semua field yang ditandai dengan warna merah',
                confirmButtonColor: '#f59e0b'
            });
        }

        return isValid;
    }

    getFieldName(field) {
        // Coba ambil label
        const label = field.previousElementSibling?.textContent ||
            field.parentElement?.previousElementSibling?.textContent ||
            field.placeholder ||
            field.name ||
            'Field ini';
        return label.replace(':', '').replace('*', '').trim();
    }

    showError(field, message) {
        this.clearError(field);

        // Untuk radio group, cari parent form-group
        if (field.type === 'radio') {
            field = field.closest('.form-group') || field;
        }

        field.classList.add('is-invalid');

        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
    }

    clearError(field) {
        // Untuk radio group, cari parent form-group
        if (field.type === 'radio') {
            field = field.closest('.form-group') || field;
        }

        field.classList.remove('is-invalid');
        const existingError = field.parentNode.querySelector('.invalid-feedback');
        if (existingError) {
            existingError.remove();
        }
    }

    goToStep(step) {
        const currentStepElement = document.getElementById(`step-${this.currentStep}`);
        const nextStepElement = document.getElementById(`step-${step}`);

        if (currentStepElement) {
            currentStepElement.classList.remove('active');
        }
        if (nextStepElement) {
            nextStepElement.classList.add('active');
        }

        this.currentStep = step;
        this.updateProgress();
    }

    updateProgress() {
        const progressBar = document.getElementById('form-progress');
        if (progressBar) {
            const progress = (this.currentStep / this.totalSteps) * 100;
            progressBar.style.width = `${progress}%`;
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    togglePerusahaanFields() {
        const jenisPenyewa = document.querySelector('input[name="jenis_penyewa"]:checked');
        if (!jenisPenyewa) return;

        const perusahaanFields = document.getElementById('data-perusahaan');
        if (!perusahaanFields) return;

        if (jenisPenyewa.value === 'Perusahaan') {
            perusahaanFields.style.display = 'block';
            perusahaanFields.querySelectorAll('[name="nama_perwakilan"], [name="npwp"], [name="perwakilan_selaku"]')
                .forEach(field => field.setAttribute('required', 'required'));
        } else {
            perusahaanFields.style.display = 'none';
            perusahaanFields.querySelectorAll('input, textarea')
                .forEach(field => field.removeAttribute('required'));
        }
    }

    resetStep1() {
        Swal.fire({
            title: 'Reset Data Step 1?',
            text: 'Semua data pada step 1 akan dihapus',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f59e0b',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Ya, Reset',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                const step1Fields = document.querySelectorAll('#step-1 input, #step-1 textarea, #step-1 select');
                step1Fields.forEach(field => {
                    if (field.type === 'radio' || field.type === 'checkbox') {
                        field.checked = false;
                    } else {
                        field.value = '';
                    }
                    this.clearError(field);
                });

                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: 'Data step 1 telah direset',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });
    }

    submitForm() {
        // Validasi semua step sebelum submit
        let allValid = true;

        for (let step = 1; step <= 3; step++) {
            if (!this.validateStep(step)) {
                allValid = false;
                // Pindah ke step yang error
                if (this.currentStep !== step) {
                    this.goToStep(step);
                }
                return; // Berhenti jika ada error
            }
        }

        if (!allValid) return;

        // Tampilkan konfirmasi
        this.showConfirmation();
    }

    showConfirmation() {
        // Ambil data untuk konfirmasi
        const namaLengkap = document.getElementById('nama_lengkap')?.value || '';
        const jenisPenyewa = document.querySelector('input[name="jenis_penyewa"]:checked')?.value || '';
        const totalHarga = document.getElementById('total_harga')?.value || '0';
        const formattedHarga = window.CurrencyCalculator.formatDisplay(totalHarga);

        Swal.fire({
            title: 'Konfirmasi Pendaftaran',
            html: `
                <div class="text-center">
                    <div class="mb-3">
                        <i class="bi bi-person-check fs-1 text-primary"></i>
                    </div>
                    <h5 class="mb-3">Apakah data sudah benar?</h5>
                    <div class="alert alert-info text-start">
                        <p class="mb-1"><strong>Nama:</strong> ${namaLengkap}</p>
                        <p class="mb-1"><strong>Jenis Penyewa:</strong> ${jenisPenyewa}</p>
                        <p class="mb-0"><strong>Total Harga:</strong> Rp ${formattedHarga}</p>
                    </div>
                    <small class="text-muted">Data akan disimpan ke database</small>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ya, Simpan',
            cancelButtonText: 'Periksa Kembali',
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#6b7280'
        }).then((result) => {
            if (result.isConfirmed) {
                this.processSubmit();
            }
        });
    }
    
    triggerCalculation() {
        if (typeof window.calculateAll === 'function') {
            window.calculateAll();
        } else if (window.CurrencyCalculator && typeof window.CurrencyCalculator.calculateAll === 'function') {
            window.CurrencyCalculator.calculateAll();
        }
    }

    async processSubmit() {
        // Tampilkan loading
        Swal.fire({
            title: 'Menyimpan...',
            text: 'Sedang menyimpan data pendaftaran',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        const form = document.getElementById('multi-step-form');
        if (!form) {
            Swal.fire('Error', 'Form tidak ditemukan', 'error');
            return;
        }

        try {
            const formData = new FormData(form);

            const response = await fetch(form.action || '/pendaftaran', {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || '',
                    'Accept': 'application/json'
                },
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: result.message || 'Pendaftaran berhasil disimpan',
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    if (result.redirect_url) {
                        window.location.href = result.redirect_url;
                    }
                });
            } else {
                let errorMsg = result.message || 'Terjadi kesalahan';
                if (result.errors) {
                    this.displayValidationErrors(result.errors);
                    errorMsg = 'Terdapat kesalahan validasi';
                }
                Swal.fire('Gagal!', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire('Error', 'Terjadi kesalahan saat mengirim data', 'error');
        }
    }

    displayValidationErrors(errors) {
        // Hapus semua error sebelumnya
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());

        // Tampilkan error baru
        for (const [fieldName, messages] of Object.entries(errors)) {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
                this.showError(field, messages[0]);
            }
        }
    }
}

// Initialize form
document.addEventListener('DOMContentLoaded', () => {
    new MultiStepForm();
});